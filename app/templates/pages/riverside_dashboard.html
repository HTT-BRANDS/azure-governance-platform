{% extends "base.html" %}

{% block title %}Riverside Compliance Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Riverside Compliance Dashboard</h1>
                    <p class="mt-1 text-sm text-gray-500">July 8, 2026 Compliance Deadline</p>
                </div>
                <div class="text-right">
                    <div class="inline-flex items-center px-4 py-2 bg-red-100 text-red-800 rounded-lg">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span class="font-bold">Financial Risk: $4M</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Countdown Card -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl shadow-lg p-6 mb-8 text-white">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-4xl font-bold" id="days">--</div>
                    <div class="text-blue-200">Days</div>
                </div>
                <div>
                    <div class="text-4xl font-bold" id="hours">--</div>
                    <div class="text-blue-200">Hours</div>
                </div>
                <div>
                    <div class="text-4xl font-bold" id="minutes">--</div>
                    <div class="text-blue-200">Minutes</div>
                </div>
                <div>
                    <div class="text-4xl font-bold" id="seconds">--</div>
                    <div class="text-blue-200">Seconds</div>
                </div>
            </div>
            <p class="text-center mt-4 text-blue-200">Until July 8, 2026 Compliance Deadline</p>
        </div>

        <!-- Executive Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Maturity Score -->
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Overall Maturity</p>
                        <p class="text-3xl font-bold text-gray-900" id="maturity-score">--</p>
                    </div>
                    <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center">
                        <span class="text-2xl">üìä</span>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Target: 3.0/5.0</span>
                        <span class="text-blue-600 font-medium" id="maturity-progress">--%</span>
                    </div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" id="maturity-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- MFA Coverage -->
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">MFA Coverage</p>
                        <p class="text-3xl font-bold text-gray-900" id="mfa-coverage">--%</p>
                    </div>
                    <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center">
                        <span class="text-2xl">üîê</span>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Target: 100%</span>
                        <span class="text-green-600 font-medium" id="mfa-progress">--%</span>
                    </div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" id="mfa-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Device Compliance -->
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Device Compliance</p>
                        <p class="text-3xl font-bold text-gray-900" id="device-compliance">--%</p>
                    </div>
                    <div class="w-16 h-16 rounded-full bg-purple-100 flex items-center justify-center">
                        <span class="text-2xl">üíª</span>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Target: 90%</span>
                        <span class="text-purple-600 font-medium" id="device-progress">--%</span>
                    </div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" id="device-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Critical Gaps -->
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Critical Gaps</p>
                        <p class="text-3xl font-bold text-gray-900" id="critical-gaps">--</p>
                    </div>
                    <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Requirements</span>
                        <span class="text-gray-600 font-medium" id="requirements-count">--/--</span>
                    </div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-red-600 h-2 rounded-full" id="requirements-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tenant Breakdown -->
        <div class="bg-white rounded-xl shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Tenant Compliance Status</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Maturity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MFA</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin MFA</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Devices</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requirements</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gaps</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="tenant-table">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Requirements by Status & Priority -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Requirements by Status -->
            <div class="bg-white rounded-xl shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Requirements by Status</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4" id="status-bars">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Requirements by Priority -->
            <div class="bg-white rounded-xl shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Requirements by Priority</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4" id="priority-bars">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Critical Gaps Panel -->
        <div class="bg-white rounded-xl shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-red-900">Critical Gaps Requiring Immediate Action</h2>
                    <span class="px-3 py-1 bg-red-600 text-white text-sm font-medium rounded-full" id="gaps-count">0</span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requirement</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="gaps-table">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Domain Maturity Radar Chart -->
        <div class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Domain Maturity Scores</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-3xl font-bold text-blue-600" id="iam-score">--</div>
                    <div class="text-sm text-gray-500">Identity & Access (IAM)</div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" id="iam-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-3xl font-bold text-green-600" id="gs-score">--</div>
                    <div class="text-sm text-gray-500">Governance & Security (GS)</div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" id="gs-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-3xl font-bold text-purple-600" id="ds-score">--</div>
                    <div class="text-sm text-gray-500">Data Security (DS)</div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" id="ds-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center space-x-4">
            <a href="/api/v1/riverside/sync" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Sync Now
            </a>
            <a href="/api/v1/riverside/requirements" class="inline-flex items-center px-6 py-3 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition">
                View All Requirements
            </a>
            <a href="/api/v1/riverside/gaps" class="inline-flex items-center px-6 py-3 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition">
                View All Gaps
            </a>
        </div>
    </div>
</div>

<script>
    // Countdown timer
    function updateCountdown() {
        const deadline = new Date('2026-07-08T00:00:00');
        const now = new Date();
        const diff = deadline - now;

        if (diff > 0) {
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('days').textContent = days;
            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
        }
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();

    // Fetch dashboard data
    async function fetchDashboardData() {
        try {
            const response = await fetch('/api/v1/riverside/summary');
            const data = await response.json();
            updateDashboard(data);
        } catch (error) {
            console.error('Failed to fetch dashboard data:', error);
        }
    }

    function updateDashboard(data) {
        // Update summary cards
        document.getElementById('maturity-score').textContent = data.overall_maturity.toFixed(1) + '/5.0';
        document.getElementById('maturity-progress').textContent = Math.round((data.overall_maturity / 5) * 100) + '%';
        document.getElementById('maturity-bar').style.width = (data.overall_maturity / 5 * 100) + '%';

        document.getElementById('mfa-coverage').textContent = data.overall_mfa_coverage.toFixed(1) + '%';
        document.getElementById('mfa-progress').textContent = data.overall_mfa_coverage.toFixed(1) + '%';
        document.getElementById('mfa-bar').style.width = data.overall_mfa_coverage + '%';

        document.getElementById('device-compliance').textContent = data.overall_device_compliance.toFixed(1) + '%';
        document.getElementById('device-progress').textContent = data.overall_device_compliance.toFixed(1) + '%';
        document.getElementById('device-bar').style.width = data.overall_device_compliance + '%';

        document.getElementById('critical-gaps').textContent = data.total_critical_gaps;
        document.getElementById('requirements-count').textContent = `${data.total_requirements_completed}/${data.total_requirements}`;
        document.getElementById('requirements-bar').style.width = data.overall_completion_pct + '%';

        // Update tenant table
        const tenantTable = document.getElementById('tenant-table');
        tenantTable.innerHTML = data.tenant_summaries.map(t => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="text-sm font-medium text-gray-900">${t.tenant_code}</div>
                        <div class="text-xs text-gray-500 ml-2">${t.tenant_name}</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${t.maturity_score.toFixed(1)}</div>
                    <div class="w-16 bg-gray-200 rounded-full h-1.5 mt-1">
                        <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${(t.maturity_score / 5 * 100)}%"></div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.mfa_coverage >= 90 ? 'bg-green-100 text-green-800' : t.mfa_coverage >= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${t.mfa_coverage.toFixed(1)}%</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.admin_mfa_pct >= 90 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.admin_mfa_pct.toFixed(1)}%</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.device_compliance >= 90 ? 'bg-green-100 text-green-800' : t.device_compliance >= 70 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${t.device_compliance.toFixed(1)}%</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.requirements_completed}/${t.requirements_total}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.critical_gaps === 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.critical_gaps}</span>
                </td>
            </tr>
        `).join('');

        // Update status bars
        const statusBars = document.getElementById('status-bars');
        const statusColors = {
            'completed': 'bg-green-600',
            'in_progress': 'bg-blue-600',
            'not_started': 'bg-gray-400',
            'blocked': 'bg-red-600'
        };
        const statusLabels = {
            'completed': 'Completed',
            'in_progress': 'In Progress',
            'not_started': 'Not Started',
            'blocked': 'Blocked'
        };
        const total = Object.values(data.requirements_by_status).reduce((a, b) => a + b, 0);
        statusBars.innerHTML = Object.entries(data.requirements_by_status).map(([status, count]) => `
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-gray-700">${statusLabels[status] || status}</span>
                    <span class="text-gray-500">${count} (${Math.round(count/total*100)}%)</span>
                </div>
                <div class="bg-gray-200 rounded-full h-2.5">
                    <div class="${statusColors[status]} h-2.5 rounded-full transition-all duration-500" style="width: ${(count/total*100)}%"></div>
                </div>
            </div>
        `).join('');

        // Update priority bars
        const priorityBars = document.getElementById('priority-bars');
        const priorityColors = {
            'P0': 'bg-red-600',
            'P1': 'bg-orange-500',
            'P2': 'bg-yellow-500'
        };
        priorityBars.innerHTML = Object.entries(data.requirements_by_priority).map(([priority, stats]) => `
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-gray-700">${priority} Priority</span>
                    <span class="text-gray-500">${stats.completed}/${stats.total}</span>
                </div>
                <div class="bg-gray-200 rounded-full h-2.5">
                    <div class="${priorityColors[priority]} h-2.5 rounded-full transition-all duration-500" style="width: ${(stats.completed/stats.total*100)}%"></div>
                </div>
            </div>
        `).join('');

        // Update gaps table
        document.getElementById('gaps-count').textContent = data.critical_gaps.length;
        const gapsTable = document.getElementById('gaps-table');
        gapsTable.innerHTML = data.critical_gaps.slice(0, 10).map(gap => `
            <tr class="${gap.is_overdue ? 'bg-red-50' : ''}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${gap.requirement_id}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${gap.title}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gap.category}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${gap.priority === 'P0' ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'}">${gap.priority}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gap.status}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${gap.is_overdue ? 'text-red-600 font-bold' : 'text-gray-500'}">${gap.due_date || 'N/A'}${gap.is_overdue ? ' (Overdue)' : ''}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${gap.risk_level === 'Critical' ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'}">${gap.risk_level}</span>
                </td>
            </tr>
        `).join('');

        // Update domain scores (will be populated by separate API call)
        fetchMaturityScores();
    }

    async function fetchMaturityScores() {
        try {
            const response = await fetch('/api/v1/riverside/maturity-scores');
            const data = await response.json();
            
            document.getElementById('iam-score').textContent = data.summary.iam_average.toFixed(1);
            document.getElementById('iam-bar').style.width = (data.summary.iam_average / 5 * 100) + '%';
            
            document.getElementById('gs-score').textContent = data.summary.gs_average.toFixed(1);
            document.getElementById('gs-bar').style.width = (data.summary.gs_average / 5 * 100) + '%';
            
            document.getElementById('ds-score').textContent = data.summary.ds_average.toFixed(1);
            document.getElementById('ds-bar').style.width = (data.summary.ds_average / 5 * 100) + '%';
        } catch (error) {
            console.error('Failed to fetch maturity scores:', error);
        }
    }

    // Initial load
    fetchDashboardData();
    // Refresh every 5 minutes
    setInterval(fetchDashboardData, 300000);
</script>
{% endblock %}
